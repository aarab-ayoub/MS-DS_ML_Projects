<!DOCTYPE html>
<html lang="en">
<head>
  {% load static %}
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PetVision AI - Classification</title>
  <link rel="stylesheet" href="{% static 'css/tailwind.min.css' %}">
  <style>
    .drop-zone {
      border: 2px dashed #6b7280;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      min-height: 200px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    .drop-zone.dragover {
      background-color: rgba(255, 255, 255, 0.1);
      border-color: #8b5cf6;
    }
    .result-animation {
      animation: fadeIn 0.5s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-indigo-900 via-purple-800 to-pink-700 min-h-screen text-white">
  <div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <header class="flex flex-col md:flex-row items-center justify-between mb-12">
      <div class="flex items-center">
        <div class="bg-white rounded-full p-2 mr-3 shadow-lg">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
          </svg>
        </div>
        <h1 class="text-3xl md:text-4xl font-bold text-white">PetVision AI</h1>
      </div>
      <nav class="mt-4 md:mt-0">
        <ul class="flex space-x-6">
          <li><a href="{% url 'landing_page' %}" class="text-white hover:text-pink-200 font-medium">Home</a></li>
          <li><a href="{% url 'training_page' %}" class="text-white hover:text-pink-200 font-medium">Try It</a></li>
          <li><a href="{% url 'prediction_page' %}" class="text-white hover:text-pink-200 font-medium">Prediction</a></li>
        </ul>
      </nav>
    </header>

      <!-- Classification Section -->
      <section class="mb-12">
        <h2 class="text-3xl font-bold text-center text-white mb-8">
          Classify Your Image
        </h2>
        <form
          method="post"
          enctype="multipart/form-data"
          class="max-w-lg mx-auto"
        >
          {% csrf_token %}
          <div class="drop-zone" id="classify-drop-zone">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-12 w-12 mx-auto text-indigo-300"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
              />
            </svg>
            <p class="text-indigo-200 mt-2">Drag and drop an image here</p>
            <p class="text-sm text-indigo-300 mt-1">or click to browse</p>
            <input
              type="file"
              name="image"
              id="classify-input"
              accept="image/*"
              class="hidden"
            />
          </div>
          <button type="submit" class="hidden" id="submit-button"></button>
        </form>

        <div
          id="result"
          class="mt-8 text-center text-2xl font-bold text-white result-animation"
        >
          {% if result %} {% if result.error %}
          <div class="bg-red-500/20 rounded-lg p-4 max-w-lg mx-auto">
            <p class="text-red-300">Unable to classify the image</p>
            <table
              class="table-auto border-collapse border border-gray-500 mx-auto mt-4"
            >
              <thead>
                <tr>
                  <th class="border border-gray-500 px-4 py-2">File Name</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="border border-gray-500 px-4 py-2">
                    {{ result.filename }}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          {% else %}
          <div
            class="bg-gradient-to-r from-purple-500/20 to-pink-500/20 rounded-lg p-6 max-w-lg mx-auto"
          >
            <p>
              This is a
              <span class="text-yellow-300">{{ result.class }}</span> with
              <span class="text-blue-300">{{ result.confidence }}</span>
              confidence!
            </p>
            {% if result.class == "Cat" %}
            <div class="text-6xl mt-4">üê±</div>
            {% else %}
            <div class="text-6xl mt-4">üê∂</div>
            {% endif %}
          </div>
          {% endif %} {% endif %}
        </div>
      </section>
    </div>

    <!-- Loading Overlay -->
    <div
      id="loading-overlay"
      class="fixed inset-0 bg-black/90 flex flex-col items-center justify-center z-50 hidden"
    >
      <div class="relative w-32 h-32">
        <div
          class="absolute inset-0 border-4 border-purple-500 border-t-transparent rounded-full animate-spin"
        ></div>
        <div class="absolute inset-0 flex items-center justify-center">
          <div class="text-purple-500 text-2xl font-bold" id="countdown">5</div>
        </div>
      </div>
      <p class="mt-6 text-xl font-semibold text-purple-200">Analyzing Image</p>
    </div>

    <script>
      const dropZone = document.getElementById("classify-drop-zone");
      const fileInput = document.getElementById("classify-input");
      const submitButton = document.getElementById("submit-button");
      const loadingOverlay = document.getElementById("loading-overlay");
      const form = document.querySelector("form");

      // Click handler
      dropZone.addEventListener("click", () => fileInput.click());

      // Drag handlers
      dropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropZone.classList.add("dragover");
      });

      dropZone.addEventListener("dragleave", () => {
        dropZone.classList.remove("dragover");
      });

      dropZone.addEventListener("drop", (e) => {
        e.preventDefault();
        dropZone.classList.remove("dragover");
        if (e.dataTransfer.files.length) {
          fileInput.files = e.dataTransfer.files;
          handleFile(fileInput.files[0]);
        }
      });

      // File input change
      fileInput.addEventListener("change", () => {
        if (fileInput.files.length) {
          handleFile(fileInput.files[0]);
        }
      });

      // Handle uploaded file
      function handleFile(file) {
        if (!file.type.match("image.*")) {
          alert("Please upload an image file");
          return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
          dropZone.innerHTML = `
          <img src="${e.target.result}" 
               class="w-full h-48 object-contain rounded-lg"
               alt="${file.name}">
          <button onclick="resetDropZone()" class="mt-2 text-indigo-300 hover:text-indigo-200">
            Choose different image
          </button>
        `;

          // Submit the form via AJAX
          submitForm(file);
        };
        reader.readAsDataURL(file);
      }

      // Submit form via AJAX
      function submitForm(file) {
        loadingOverlay.style.display = "flex";
        startCountdown(5);

        const formData = new FormData();
        formData.append("image", file);
        formData.append(
          "csrfmiddlewaretoken",
          document.querySelector("[name=csrfmiddlewaretoken]").value
        );

        fetch(window.location.href, {
          method: "POST",
          body: formData,
          headers: {
            "X-Requested-With": "XMLHttpRequest",
          },
        })
          .then((response) => response.text())
          .then((html) => {
            // Create a temporary element to parse the response
            const tempDiv = document.createElement("div");
            tempDiv.innerHTML = html;

            // Extract the result section
            const newResult = tempDiv.querySelector("#result");
            if (newResult) {
              document.getElementById("result").innerHTML = newResult.innerHTML;
            }
          })
          .catch((error) => {
            console.error("Error:", error);
          })
          .finally(() => {
            loadingOverlay.style.display = "none";
          });
      }

      // Reset drop zone
      function resetDropZone() {
        dropZone.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-indigo-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
        </svg>
        <p class="text-indigo-200 mt-2">Drag and drop an image here</p>
        <p class="text-sm text-indigo-300 mt-1">or click to browse</p>
      `;
        fileInput.value = "";
        document.getElementById("result").innerHTML = "";
      }

      // Countdown animation
      function startCountdown(seconds) {
        let count = seconds;
        const countdownElement = document.getElementById("countdown");

        const interval = setInterval(() => {
          countdownElement.textContent = count;
          count--;

          if (count < 0) {
            clearInterval(interval);
          }
        }, 1000);
      }

      // Prevent default form submission
      form.addEventListener("submit", function (e) {
        e.preventDefault();
        if (fileInput.files.length) {
          handleFile(fileInput.files[0]);
        }
      });
    </script>
  </body>
</html>
